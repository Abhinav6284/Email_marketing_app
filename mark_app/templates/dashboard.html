{% extends 'base.html' %}
{% block title %}Dashboard – Mark{% endblock %}

{% block content %}
<style>
/* Dashboard: White & Black Theme */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

/* Global font setup */
body {
    font-family: 'Poppins', sans-serif;
    font-size: 13px; /* premium default */
    font-weight: 400;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Root colors & spacing */
:root {
    --db-bg: #F3F4F6;
    --db-surface: #FFFFFF;
    --db-border: #E5E7EB;
    --db-primary-text: #111827;
    --db-secondary-text: #6B7280;
    --db-accent: #111827;
    --radius-lg: 12px;
}

/* Background */
body {
    background-color: var(--db-bg);
    color: var(--db-primary-text);
}

/* Layout */
.dashboard-wrapper {
    display: flex;
    min-height: 100vh;
}

/* Sidebar */
.sidebar {
    width: 250px;
    background-color: var(--db-surface);
    border-right: 1px solid var(--db-border);
    padding: 24px;
    position: fixed;
    height: 100%;
    display: flex;
    flex-direction: column;
    z-index: 100;
}

.sidebar-header {
    text-align: center;
    margin-bottom: 40px;
}

.sidebar-logo {
    width: 60px;
    height: auto;
    margin-bottom: 12px;
}

.sidebar-title {
    font-size: 18px; /* smaller premium */
    font-weight: 700;
    color: var(--db-primary-text);
    letter-spacing: -0.3px;
}

/* Navigation */
.sidebar-nav {
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex-grow: 1;
}

.nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-radius: 8px;
    font-weight: 500;
    font-size: 13px; /* clean, small */
    color: var(--db-secondary-text);
    text-decoration: none;
    transition: all 0.2s ease;
    cursor: pointer;
}

.nav-item:hover {
    background-color: var(--db-bg);
    color: var(--db-primary-text);
}

.nav-item.active {
    background-color: var(--db-accent);
    color: white;
}

.nav-item.active svg {
    color: white;
}

.nav-item svg {
    width: 18px;
    height: 18px;
    color: var(--db-secondary-text);
}

/* Main Content */
.main-content {
    margin-left: 250px;
    flex-grow: 1;
    padding: 32px;
}

.dashboard-header {
    background-color: var(--db-surface);
    border: 1px solid var(--db-border);
    border-radius: var(--radius-lg);
    padding: 12px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.page-title {
    font-size: 16px; /* premium small */
    font-weight: 600;
    color: var(--db-primary-text);
    letter-spacing: -0.2px;
}

.user-profile {
    display: flex;
    align-items: center;
    gap: 12px;
    text-decoration: none;
    color: var(--db-primary-text);
    font-weight: 500;
    font-size: 13px;
}

.user-avatar {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    object-fit: cover;
}

/* Sections */
.section {
    display: none;
}

.section.active {
    display: block;
    animation: fadeIn 0.5s ease;
}

/* Smooth fade */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
    /* Stats & Charts */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
    }

    .stat-card {
        background: var(--db-surface);
        padding: 24px;
        border-radius: var(--radius-lg);
        border: 1px solid var(--db-border);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .stat-label {
        font-size: 14px;
        color: var(--db-secondary-text);
        margin-bottom: 8px;
    }

    .stat-number {
        font-size: 32px;
        font-weight: 700;
        color: var(--db-primary-text);
    }

    .charts-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 24px;
        margin-bottom: 32px;
    }

    .chart-panel {
        background: var(--db-surface);
        padding: 24px;
        border-radius: var(--radius-lg);
        border: 1px solid var(--db-border);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        position: relative;
        height: 400px;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .panel-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 0;
    }

    .date-filter-form {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .date-filter-form input[type="date"] {
        border: 1px solid var(--db-border);
        border-radius: 6px;
        padding: 4px 8px;
        font-size: 13px;
        color: var(--db-secondary-text);
    }

    .date-filter-form button {
        background-color: var(--db-accent);
        color: white;
        border: none;
        padding: 5px 12px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
    }

    .overview-panel-body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        height: calc(100% - 40px);
    }

    .overview-chart-container {
        position: relative;
        height: 140px !important;
        width: 140px !important;
        margin: 0 auto;
        margin-bottom: 24px;
    }

    .overview-legend {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .legend-icon-wrapper {
        width: 16px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .legend-color-box {
        width: 12px;
        height: 12px;
        border-radius: 3px;
    }

    .legend-label {
        color: var(--db-secondary-text);
        font-size: 14px;
    }

    .legend-value {
        font-size: 16px;
        font-weight: 600;
        color: var(--db-primary-text);
        margin-left: auto;
    }

    /* Contacts & Campaigns */
    .content-panel {
        background: var(--db-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--db-border);
        margin-top: 32px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .panel-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--db-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .panel-body {
        padding: 24px;
    }

    .contacts-layout {
        display: grid;
        grid-template-columns: 380px 1fr;
        gap: 24px;
    }

    .campaign-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: var(--db-secondary-text);
        margin-bottom: 8px;
    }

    .form-input,
    .form-textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--db-border);
        border-radius: 8px;
        font-size: 14px;
        background-color: var(--db-bg);
        color: var(--db-primary-text);
        transition: all 0.2s ease;
    }

    .form-input:focus,
    .form-textarea:focus {
        outline: none;
        border-color: var(--db-accent);
    }

    .btn-db {
        background: var(--db-accent);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease;
        width: 100%;
        font-size: 14px;
    }

    .btn-db:hover {
        background-color: #374151;
    }

    .contacts-table {
        width: 100%;
        border-collapse: collapse;
    }

    .contacts-table th,
    .contacts-table td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid var(--db-border);
    }

    .contacts-table th {
        font-size: 12px;
        color: var(--db-secondary-text);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-danger {
        background-color: #FEE2E2;
        color: #B91C1C;
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        border: none;
    }

    .btn-edit {
        background-color: #DBEAFE;
        color: #1D4ED8;
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        border: none;
    }

    .btn-edit:hover {
        background-color: #BFDBFE;
    }

    /* Responsive */
    .mobile-menu-btn {
        display: none;
    }

    @media (max-width: 1200px) {
        .charts-grid,
        .contacts-layout,
        .campaign-layout {
            grid-template-columns: 1fr;
        }
        
        .form-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 1024px) {
        .sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .main-content {
            margin-left: 0;
        }

        .mobile-menu-btn {
            display: block;
            background: none;
            border: none;
            color: var(--db-primary-text);
            font-size: 24px;
            cursor: pointer;
        }
        
        .content-panel {
            margin: 0.5rem;
            padding: 1rem;
        }
        
        .panel-header {
            padding: 1rem;
        }
        
        .contacts-table {
            font-size: 12px;
        }
        
        .contacts-table th,
        .contacts-table td {
            padding: 8px 6px;
        }
    }

    @media (max-width: 768px) {
        .dashboard-wrapper {
            flex-direction: column;
        }
        
        .sidebar {
            width: 100%;
            height: auto;
            position: relative;
            transform: none;
        }
        
        .sidebar.open {
            display: block;
        }
        
        .main-content {
            margin-left: 0;
            padding: 0.5rem;
        }
        
        .content-header {
            padding: 1rem 0.5rem;
        }
        
        .stats-overview {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        
        .stat-card {
            padding: 1rem;
        }
        
        .stat-value {
            font-size: 1.25rem;
        }
        
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .contacts-table {
            font-size: 11px;
            display: block;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .panel-title {
            font-size: 1rem;
        }
        
        .btn-db {
            padding: 6px 12px;
            font-size: 12px;
        }
    }

    @media (max-width: 480px) {
        .stats-overview {
            grid-template-columns: 1fr;
        }
        
        .stat-card {
            padding: 0.75rem;
        }
        
        .content-panel {
            margin: 0.25rem;
        }
        
        .form-input,
        .form-textarea {
            font-size: 14px;
            padding: 8px;
        }
        
        .contacts-table th,
        .contacts-table td {
            padding: 6px 4px;
            font-size: 10px;
        }
        
        .btn-edit,
        .btn-danger {
            padding: 4px 8px;
            font-size: 10px;
        }
        
        .sidebar-header {
            padding: 1rem;
        }
        
        .sidebar-title {
            font-size: 1rem;
        }
    }
</style>

<div class="dashboard-wrapper">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="{{ url_for('static', filename='images/logo2.png') }}" alt="Mark Logo" class="sidebar-logo">
            <h1 class="sidebar-title">Connect Leads</h1>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item active" onclick="showSection(event, 'dashboard')">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                    </path>
                </svg>
                <span>Dashboard</span>
            </div>
           
            <div class="nav-item" onclick="showSection(event, 'contacts')">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                    </path>
                </svg>
                <span>Contacts</span>
            </div>
            <div class="nav-item" onclick="showSection(event, 'email')">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                    </path>
                </svg>
                <span>Email Campaign</span>
            </div>
            <div class="nav-item" onclick="showSection(event, 'campaigns')">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                    </path>
                </svg>
                <span>Campaign History</span>
            </div>
            <div class="nav-item" onclick="showSection(event, 'replies')">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 8l7.89 5.26L3 18V8zm7.89 5.26L21 8v10l-10.11-4.74z"></path>
                </svg>
                <span>Leads</span>
            </div>
              <div class="nav-item" onclick="showSection(event, 'whatsapp')">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="24" height="24" fill="currentColor">
  <path d="M16 3C9.372 3 4 8.372 4 15c0 2.63.868 5.07 2.322 7.01L4 29l7.186-2.306A11.947 11.947 0 0016 27c6.627 0 12-5.373 12-12S22.627 3 16 3zm0 21c-1.946 0-3.774-.568-5.31-1.538l-.38-.228-4.264 1.37 1.38-4.15-.247-.386A9.952 9.952 0 016 15c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10zm5.427-7.803c-.273-.136-1.614-.797-1.864-.888-.25-.091-.431-.136-.612.136s-.702.888-.861 1.073c-.159.182-.318.204-.592.068-.273-.136-1.15-.423-2.19-1.345-.811-.723-1.357-1.615-1.518-1.888-.159-.273-.017-.42.12-.555.123-.123.273-.318.409-.477.136-.159.182-.273.273-.455.091-.182.045-.341-.023-.477-.068-.136-.612-1.475-.838-2.022-.22-.531-.445-.458-.612-.467-.159-.009-.341-.011-.523-.011s-.477.068-.73.341c-.25.273-.95.928-.95 2.263 0 1.334.974 2.625 1.11 2.808.136.182 1.917 2.926 4.646 4.102.65.281 1.157.448 1.552.573.652.21 1.246.181 1.714.11.523-.081 1.614-.658 1.841-1.293.227-.636.227-1.182.159-1.293-.068-.114-.25-.182-.523-.318z"/>
</svg>

                <span>Whatsapp Connect</span>
            </div>
    
            

        </nav>
        <div class="sidebar-footer">
            <div class="nav-item" onclick="showSection(event, 'settings')">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z">
                    </path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span>Settings</span>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <header class="dashboard-header">
            <button class="mobile-menu-btn" onclick="toggleSidebar()">☰</button>
            <h2 class="page-title" id="pageTitle">Dashboard</h2>
            <a href="{{ url_for('main.profile_settings') }}" class="user-profile">
                <img src="{{ url_for('main.user_avatar') }}" alt="User Avatar" class="user-avatar">
                <span>{{ current_user.first_name }}</span>
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </a>
        </header>

        <div class="content-area">
            <section class="section active" id="dashboard">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Contacts</div>
                        <div class="stat-number">{{ total_contacts or 0 }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Campaigns Sent</div>
                        <div class="stat-number">{{ total_campaigns or 0 }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Emails Sent</div>
                        <div class="stat-number">{{ total_emails_sent or 0 }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Successful Campaigns</div>
                        <div class="stat-number">{{ successful_campaigns or 0 }}</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-panel">
                        <div class="chart-header">
                            <h3 class="panel-title">Email Activity</h3>
                            <div class="date-filter-form">
                                <input type="date" id="start_date_input">
                                <input type="date" id="end_date_input">
                                <button type="button" id="filter_chart_btn">Filter</button>
                            </div>
                        </div>
                        <canvas id="emailSentChart"></canvas>
                    </div>
                    <div class="chart-panel">
                        <div class="chart-header">
                            <h3 class="panel-title">Overview</h3>
                        </div>
                        <div class="overview-panel-body">
                            <div class="overview-chart-container">
                                <canvas id="campaignsChart"></canvas>
                            </div>
                            <div class="overview-legend">
                                <div class="legend-item">
                                    <div class="legend-icon-wrapper">
                                        <div class="legend-color-box" style="background-color: #22C55E;"></div>
                                    </div>
                                    <span class="legend-label">Successful</span>
                                    <span class="legend-value">{{ successful_campaigns or 0 }}</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-icon-wrapper">
                                        <div class="legend-color-box" style="background-color: #EF4444;"></div>
                                    </div>
                                    <span class="legend-label">Failed</span>
                                    <span class="legend-value">{{ failed_campaigns or 0 }}</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-icon-wrapper">
                                        <div class="legend-color-box" style="background-color: #3B82F6;"></div>
                                    </div>
                                    <span class="legend-label">Contacts Added Today</span>
                                    <span class="legend-value">{{ contacts_added_today or 0 }}</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-icon-wrapper">
                                        <div class="legend-color-box" style="background-color: #8B5CF6;"></div>
                                    </div>
                                    <span class="legend-label">Total Emails Sent</span>
                                    <span class="legend-value">{{ total_emails_sent or 0 }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section class="section" id="whatsapp_campaign">
                <form action="{{ url_for('whatsapp.whatsapp_settings') }}" method="POST">
                    <div class="campaign-layout">
                        <div class="content-panel" style="margin-top:0;">
                            <div class="panel-header">
                                <h3 class="panel-title">Create New WhatsApp Campaign</h3>
                            </div>
                            <div class="panel-body">
                                <div class="form-group">
                                    <label class="form-label">Message *</label>
                                    <textarea name="message" class="form-textarea" rows="8" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Send To:</label>
                                    <div style="display: flex; gap: 20px;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <input type="radio" id="wa_send_all" name="send_to_option" value="all"
                                                checked>
                                            <label for="wa_send_all" style="cursor: pointer;">All Contacts</label>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <input type="radio" id="wa_send_selected" name="send_to_option"
                                                value="selected">
                                            <label for="wa_send_selected" style="cursor: pointer;">Selected
                                                Contacts</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="content-panel" style="margin-top:0;">
                            <div class="panel-header">
                                <h3 class="panel-title">Select Contacts</h3>
                            </div>
                            <div class="panel-body" style="padding: 0; max-height: 500px; overflow-y: auto;">
                                <table class="contacts-table">
    <thead>
        <tr>
            <th><input type="checkbox" id="wa_select_all_contacts"></th>
            <th>Company</th>
            <th>Contact</th>
            <th>Phone</th>
            <th>Location</th>
        </tr>
    </thead>
    <tbody>
        {% for contact in contacts %}
        <tr>
            <td>
                <input type="checkbox" class="wa-contact-checkbox"
                       name="selected_contacts" value="{{ contact.id }}">
            </td>
            <td><strong>{{ contact.company_name }}</strong></td>
            <td>{{ contact.contact or '-' }}</td>
            <td>{{ contact.phone_number or '-' }}</td>
            <td>{{ contact.location or '-' }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
                            </div>
                        </div>
                    </div>

                    <div class="content-panel">
                        <div class="panel-body">
                            <button type="submit" name="send_whatsapp" value="1" class="btn-db"
                                style="background: #25D366;">
                                Send WhatsApp Campaign
                            </button>
                        </div>
                    </div>
                </form>
            </section>
            <section class="section" id="contacts">
                <div class="contacts-layout">
                    <div class="content-panel" style="margin-top:0;">
                        <div class="panel-header">
                            <h3 class="panel-title">Add New Contact</h3>
                        </div>
                        <div class="panel-body">
                            <form method="POST">
                                <input type="hidden" name="add_contact" value="1">
                                <div class="form-group"><label class="form-label">Company Name *</label><input
                                        type="text" name="company_name" class="form-input" required></div>
                                <div class="form-group"><label class="form-label">Email *</label><input type="email"
                                        name="email" class="form-input" required></div>
                                <div class="form-group"><label class="form-label">Contact Person</label><input
                                        type="text" name="contact" class="form-input"></div>
                                <div class="form-group"><label class="form-label">Phone Number</label><input type="text"
                                        name="phone_number" class="form-input"></div>
                                <div class="form-group"><label class="form-label">Company Type</label><input type="text"
                                        name="company_type" class="form-input"></div>
                                <div class="form-group"><label class="form-label">Location</label><input type="text"
                                        name="location" class="form-input"></div>
                                <button type="submit" class="btn-db">Add Contact</button>
                            </form>
                        </div>
                    </div>

                    <div class="content-panel" style="margin-top:0;">
                        <div class="panel-header">
                            <h3 class="panel-title">Your Contacts ({{ total_contacts or 0 }})</h3>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <a href="{{ url_for('main.download_template') }}"
                                    style="font-size: 12px; color: var(--db-accent); text-decoration: none;">
                                    Download Template
                                </a>
                                <form method="POST" enctype="multipart/form-data"
                                    style="display: flex; align-items: center; gap: 8px; margin-left: 10px;">
                                    <input type="hidden" name="import_contacts" value="1">
                                    <input type="file" name="file" accept=".csv, .xlsx" required
                                        style="font-size: 12px; max-width: 200px;">
                                    <button type="submit" class="btn-db"
                                        style="width: auto; font-size: 12px; padding: 8px 16px;">
                                        Import
                                    </button>
                                </form>
                                <a href="{{ url_for('main.export_contacts') }}" class="btn-db"
                                    style="width: auto; font-size: 12px; padding: 8px 16px; background-color: #6B7280;">Export
                                    All</a>
                            </div>
                        </div>
                        <div class="panel-body" style="padding: 0; max-height: 500px; overflow-y: auto;">
                            <table class="contacts-table">
                                <thead>
                                    <tr>
                                        <th>Company</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for contact in contacts %}
                                    <tr>
                                        <td><strong>{{ contact.company_name }}</strong><br><small
                                                style="color: var(--db-secondary-text);">{{ contact.contact or '-'
                                                }}</small></td>
                                        <td><a href="mailto:{{ contact.email }}">{{ contact.email }}</a></td>
                                        <td>{{ contact.phone_number or '-' }}</td>
                                        <td>
                                            <div style="display: flex; gap: 8px;">
                                                <button type="button" onclick="editContact({{ contact.id }}, '{{ contact.company_name|e }}', '{{ contact.contact|e }}', '{{ contact.email|e }}', '{{ contact.phone_number|e }}', '{{ contact.company_type|e }}', '{{ contact.location|e }}')" class="btn-edit">Edit</button>
                                                <form method="POST" onsubmit="return confirm('Are you sure?')" style="display: inline;">
                                                    <input type="hidden" name="contact_id" value="{{ contact.id }}">
                                                    <button type="submit" name="delete_contact"
                                                        class="btn-danger">Delete</button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4"
                                            style="text-align: center; padding: 40px; color: var(--db-secondary-text);">
                                            No contacts found. Add one to get started!
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
<script>
function toggleHistory(id) {
    const el = document.getElementById(id);
    el.style.display = (el.style.display === "none" || el.style.display === "") ? "table-row" : "none";
}
</script>

            <section class="section" id="email">
                <form method="POST" enctype="multipart/form-data">
                    <div class="campaign-layout">
                        <div class="content-panel" style="margin-top:0;">
                            <div class="panel-header">
                                <h3 class="panel-title">Create New Email Campaign</h3>
                            </div>
                            <div class="panel-body">
                                <div class="form-group"><label class="form-label">Subject *</label><input type="text"
                                        name="subject" class="form-input" required></div>
                                <div class="form-group"><label class="form-label">Message *</label><textarea
                                        name="message" class="form-textarea" rows="8" required></textarea></div>
                                <div class="form-group"><label class="form-label">Attachments (Optional)</label><input
                                        type="file" name="attachments" class="form-input"></div>
                                <div class="form-group">
                                    <label class="form-label">Send To:</label>
                                    <div style="display: flex; gap: 20px;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <input type="radio" id="send_all_option" name="send_to_option" value="all"
                                                checked>
                                            <label for="send_all_option" style="cursor: pointer;">All Contacts</label>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <input type="radio" id="send_selected_option" name="send_to_option"
                                                value="selected">
                                            <label for="send_selected_option" style="cursor: pointer;">Selected
                                                Contacts</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="content-panel" style="margin-top:0;">
                            <div class="panel-header">
                                <h3 class="panel-title">Select Contacts</h3>
                            </div>
                            <div class="panel-body" style="padding: 0; max-height: 500px; overflow-y: auto;">
                                <table class="contacts-table">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" id="select_all_contacts"></th>
                                            <th>Company</th>
                                            <th>Email</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for contact in contacts %}
                                        <tr>
                                            <td><input type="checkbox" class="contact-checkbox" name="selected_contacts"
                                                    value="{{ contact.id }}"></td>
                                            <td><strong>{{ contact.company_name }}</strong></td>
                                            <td>{{ contact.email }}</td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="3"
                                                style="text-align: center; padding: 40px; color: var(--db-secondary-text);">
                                                No contacts to select.
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="content-panel">
                        <div class="panel-body">
                            <button type="submit" name="send_email" value="1" class="btn-db">Send Campaign</button>
                        </div>
                    </div>
                </form>
            </section>

      <section class="section" id="whatsapp">
    <div class="content-panel" style="margin-top:0;">
        <div class="panel-header">
            <h3 class="panel-title">WhatsApp Settings</h3>
        </div>

        <div class="panel-body" style="padding: 0;">
            {% if contacts %}
            <!-- Search Box -->
            <div style="padding:12px; background:#fafafa; border-bottom:1px solid #e5e5e5;">
                <input type="text" id="searchInput" placeholder="Search company name..." 
                       style="width:100%; padding:8px 12px; border-radius:6px; border:1px solid #d1d5db; font-size:13px;">
            </div>

            <div style="max-height:600px; overflow-y:auto;">
                <table class="contacts-table" style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="background:#fafafa; text-align:left;">
                            <th>Company</th>
                            <th>Contact</th>
                            <th>Phone</th>
                            <th>Location</th>
                            <th>Message</th>
                            <th>History</th>
                        </tr>
                    </thead>
                    <tbody id="contactTableBody">
                        {% for c in contacts %}
                        <tr data-company="{{ c.company_name|lower }}">
                            <td><strong>{{ c.company_name }}</strong></td>
                            <td>{{ c.contact or '-' }}</td>
                            <td>{{ c.phone_number or '-' }}</td>
                            <td>{{ c.location or '-' }}</td>
                            <td>
                                <form action="{{ url_for('whatsapp.send_message', contact_id=c.id) }}" method="POST" enctype="multipart/form-data" style="display:flex; flex-direction:column; gap:4px;">
                                    <textarea name="message" placeholder="Type message" style="width:100%; min-height:60px; padding:6px 10px; font-size:13px;" required></textarea>
                                    <input type="file" name="attachment" style="padding:4px;">
                                    <button type="submit" style="padding:4px 8px; background:#22C55E; color:#fff; border:none; border-radius:4px; font-size:12px;">Send</button>
                                </form>
                            </td>
                            <td>
                                <button onclick="toggleHistory('history-{{ c.id }}')" style="padding:4px 8px; background:#2563EB; color:#fff; border:none; border-radius:4px; font-size:11px; cursor:pointer;">View</button>
                            </td>
                        </tr>
                        <tr id="history-{{ c.id }}" style="display:none;">
                            <td colspan="6" style="padding:12px; background:#f9fafb;">
                                {% if c.messages %}
                                    {% for msg in c.messages %}
                                    <div style="margin-bottom:6px; padding:6px; background:#fff; border:1px solid #e5e5e5; border-radius:4px;">
                                        <strong>{{ msg.date.strftime('%Y-%m-%d %H:%M') }}</strong>: {{ msg.message }}
                                        {% if msg.attachment %}
                                            <div><a href="{{ msg.attachment }}" target="_blank">View Attachment</a></div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div style="color:#9ca3af; font-style:italic;">No previous messages.</div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="text-align:center; padding:60px 20px;">
                <svg style="width:64px; height:64px; color:#d1d5db; margin-bottom:16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                </svg>
                <h3 style="margin:0 0 8px 0; color:#111827;">No Contacts Yet</h3>
                <p style="color:#6b7280; margin:0;">Add contacts to send WhatsApp messages.</p>
            </div>
            {% endif %}
        </div>
    </div>
</section>

<script>
function toggleHistory(id) {
    var elem = document.getElementById(id);
    elem.style.display = elem.style.display === 'none' ? 'table-row' : 'none';
}

// Search functionality
document.getElementById('searchInput').addEventListener('keyup', function() {
    var filter = this.value.toLowerCase();
    var rows = document.querySelectorAll('#contactTableBody tr[data-company]');
    rows.forEach(function(row) {
        row.style.display = row.dataset.company.includes(filter) ? '' : 'none';
        var historyRow = document.getElementById('history-' + row.dataset.company);
        if(historyRow) historyRow.style.display = 'none';
    });
});
</script>



            <section class="section" id="campaigns">
                <div class="content-panel" style="margin-top:0;">
                    <div class="panel-header">
                        <h3 class="panel-title">Campaign History</h3>
                        <div style="display: flex; gap: 12px;">
                            <form method="POST" id="deleteSelectedCampaignsForm" style="display: inline;">
                                <button type="submit" name="delete_selected_campaigns" value="1" class="btn-danger"
                                    onclick="return confirmDeleteSelected()"
                                    style="background: #F59E0B; color: white; padding: 8px 16px; font-size: 12px;">
                                    Delete Selected
                                </button>
                            </form>
                            <form method="POST" style="display: inline;">
                                <button type="submit" name="clear_all_campaigns" value="1" class="btn-danger"
                                    onclick="return confirm('Are you sure you want to clear all campaign history?')"
                                    style="background: #EF4444; color: white; padding: 8px 16px; font-size: 12px;">
                                    Clear All
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="panel-body" style="padding: 0;">
                        {% if campaigns %}
                        <div style="max-height: 600px; overflow-y: auto;">
                            <table class="contacts-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAllCampaigns" onchange="toggleAllCampaigns()"></th>
                                        <th>Subject</th>
                                        <th>Sent Date</th>
                                        <th>Recipients</th>
                                        <th>Success</th>
                                        <th>Failed</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for campaign in campaigns %}
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="selected_campaigns" value="{{ campaign.id }}" class="campaign-checkbox">
                                        </td>
                                        <td>
                                            <strong>{{ campaign.subject }}</strong>
                                            <br>
                                            <small style="color: var(--db-secondary-text);">
                                                {{ campaign.message[:50] }}{% if campaign.message|length > 50 %}...{%
                                                endif %}
                                            </small>
                                        </td>
                                        <td>{{ campaign.sent_at.strftime('%Y-%m-%d %H:%M') if campaign.sent_at else
                                            'N/A' }}</td>
                                        <td><span style="font-weight: 600;">{{ campaign.recipient_count or 0 }}</span>
                                        </td>
                                        <td><span style="color: #22C55E; font-weight: 600;">{{ campaign.success_count or
                                                0 }}</span></td>
                                        <td><span style="color: #EF4444; font-weight: 600;">{{ campaign.failed_count or
                                                0 }}</span></td>
                                        <td>
                                            <button onclick="toggleCampaignDetails('campaign-{{ campaign.id }}')"
                                                style="background: var(--db-accent); color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                                View
                                            </button>
                                        </td>
                                    </tr>
                                    <tr id="campaign-{{ campaign.id }}" class="campaign-details" style="display: none;">
                                        <td colspan="6" style="padding: 20px; background-color: var(--db-bg);">
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                                <div>
                                                    <h4 style="margin: 0 0 10px 0; color: var(--db-primary-text);">
                                                        Campaign Details</h4>
                                                    <p><strong>Full Message:</strong></p>
                                                    <div
                                                        style="background: white; padding: 12px; border-radius: 6px; border: 1px solid var(--db-border); max-height: 150px; overflow-y: auto;">
                                                        {{ campaign.message | replace('\n', '<br>') | safe }}
                                                    </div>
                                                    {% if campaign.attachments %}
                                                    <p style="margin-top: 10px;">
                                                        <strong>Attachments:</strong> {{ campaign.attachments }}
                                                    </p>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    <h4 style="margin: 0 0 10px 0; color: var(--db-primary-text);">
                                                        Delivery Status</h4>
                                                    {% if campaign.delivery_details %}
                                                    <div
                                                        style="background: white; padding: 12px; border-radius: 6px; border: 1px solid var(--db-border); max-height: 150px; overflow-y: auto;">
                                                        {% for detail in campaign.delivery_details %}
                                                        <div
                                                            style="margin-bottom: 8px; padding: 6px; border-radius: 4px; {{ 'background-color: #F0FDF4; color: #166534;' if detail.status == 'success' else 'background-color: #FEF2F2; color: #DC2626;' }}">
                                                            <strong>{{ detail.email }}:</strong> {{ detail.status }}
                                                            {% if detail.error %}<br><small>{{ detail.error }}</small>{%
                                                            endif %}
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                    {% else %}
                                                    <p style="color: var(--db-secondary-text);">No detailed delivery
                                                        information available.</p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div style="text-align: center; padding: 60px 20px;">
                            <svg style="width: 64px; height: 64px; color: var(--db-border); margin-bottom: 16px;"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                                    d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4">
                                </path>
                            </svg>
                            <h3 style="margin: 0 0 8px 0; color: var(--db-primary-text);">No Campaigns Yet</h3>
                            <p style="color: var(--db-secondary-text); margin: 0;">Send your first email campaign to see
                                it here!</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </section>

        <section class="section" id="replies">
         
    <style>
        .btn-view-details {
            background-color: #F3F4F6;
            color: #374151;
            border: 1px solid #E5E7EB;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }

        .btn-view-details:hover {
            background-color: #E5E7EB;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            padding-top: 80px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(17, 24, 39, 0.6);
        }

        .modal-content {
            background-color: #FFFFFF;
            margin: auto;
            padding: 24px;
            border-radius: 12px;
            max-width: 700px;
            position: relative;
            border: 1px solid #E5E7EB;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .close {
            color: #9CA3AF;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close:hover {
            color: #111827;
        }

        .modal-content h3 {
            margin-top: 0;
            font-size: 20px;
            color: #111827;
        }

        .modal-content p {
            color: #6B7280;
            font-size: 14px;
        }

        .modal-content pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: inherit;
            font-size: 15px;
            background-color: #F9FAFB;
            border: 1px solid #F3F4F6;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            color: #374151;
            max-height: 40vh;
            overflow-y: auto;
        }
    </style>

    <div class="content-panel" style="margin-top:0;">
        <div class="panel-header">
            <h3 class="panel-title">Received Replies</h3>
            <form action="{{ url_for('main.fetch_replies_route') }}" method="get">
    <button type="submit" 
        style="
            padding: 0.6rem 1.2rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.85rem;
            text-decoration: none;
            background: #fff;
            color: #111827;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        "
        onmouseover="this.style.background='#f9fafb'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"
        onmouseout="this.style.background='#fff'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';"
    >
        🔄 Fetch Email Replies
    </button>
</form>
        </div>
        <div class="panel-body" style="padding: 0;">
            <div style="overflow-y: auto;">
                 <table class="contacts-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Sender Name</th>
                            <th>Email</th>
                            <th>Subject</th>
                            <th>Received At</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in replies %}
                        <tr data-id="{{ r.id }}">
                            <td>{{ r.id }}</td>
                            <td>{{ r.sender_name if r.sender_name else 'N/A' }}</td>
                            <td>{{ r.sender_email }}</td>
                            <td>{{ r.subject or '(No Subject)' }}</td>
                            <td>{{ r.received_at.strftime("%Y-%m-%d %H:%M") if r.received_at else 'N/A' }}</td>
                            <td>
                                <button class="btn-view-details"
                                    data-id="{{ r.id }}"
                                    data-name="{{ r.sender_name if r.sender_name else 'N/A' }}"
                                    data-email="{{ r.sender_email }}"
                                    data-subject="{{ r.subject or '(No Subject)' }}"
                                    data-body="{{ r.body|e if r.body else '' }}"
                                    data-date="{{ r.received_at.strftime('%B %d, %Y at %H:%M') if r.received_at else 'N/A' }}">
                                    View
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6"
                                style="text-align: center; padding: 40px; color: var(--db-secondary-text);">
                                You haven't received any replies yet.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
            </section>

        <!-- Settings Section -->
        <section class="section" id="settings" style="display: none;">
            <div class="content-panel" style="margin-top:0;">
                <div class="panel-header">
                    <h3 class="panel-title">Integration Settings</h3>
                </div>
                
                <!-- SMTP Settings -->
                <div class="panel-body">
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem; color: var(--db-primary-text);">Email (SMTP) Settings</h4>
                        <form method="POST" style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <input type="hidden" name="settings_type" value="smtp">
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 5px; color: var(--db-secondary-text); font-size: 12px;">Send Method</label>
                                <select name="send_method" id="send_method" onchange="toggleSmtpFields()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="builtin" {% if not current_user.use_custom_smtp %}selected{% endif %}>Use System SMTP</option>
                                    <option value="custom" {% if current_user.use_custom_smtp %}selected{% endif %}>Custom SMTP</option>
                                </select>
                            </div>
                            
                            <div id="customSmtpFields" style="{% if not current_user.use_custom_smtp %}display: none;{% endif %}">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; color: var(--db-secondary-text); font-size: 12px;">SMTP Server</label>
                                        <select name="smtp_server" id="smtp_server" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                            <option value="smtp.gmail.com" {% if current_user.smtp_server == 'smtp.gmail.com' %}selected{% endif %}>Gmail</option>
                                            <option value="smtp.outlook.com" {% if current_user.smtp_server == 'smtp.outlook.com' %}selected{% endif %}>Outlook</option>
                                            <option value="smtp.mail.yahoo.com" {% if current_user.smtp_server == 'smtp.mail.yahoo.com' %}selected{% endif %}>Yahoo</option>
                                            <option value="custom" {% if current_user.smtp_server not in ['smtp.gmail.com', 'smtp.outlook.com', 'smtp.mail.yahoo.com'] %}selected{% endif %}>Other/Custom</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; color: var(--db-secondary-text); font-size: 12px;">SMTP Port</label>
                                        <input type="number" name="smtp_port" value="{{ current_user.smtp_port or 587 }}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px;" id="customServerField" {% if current_user.smtp_server in ['smtp.gmail.com', 'smtp.outlook.com', 'smtp.mail.yahoo.com'] %}style="display: none;"{% endif %}>
                                    <label style="display: block; margin-bottom: 5px; color: var(--db-secondary-text); font-size: 12px;">Custom SMTP Server</label>
                                    <input type="text" name="custom_smtp_server" value="{{ current_user.smtp_server or '' }}" placeholder="mail.yourcompany.com" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; color: var(--db-secondary-text); font-size: 12px;">Email</label>
                                        <input type="email" name="smtp_email" value="{{ current_user.smtp_email or '' }}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; color: var(--db-secondary-text); font-size: 12px;">Sender Name</label>
                                        <input type="text" name="smtp_sender_name" value="{{ current_user.smtp_sender_name or '' }}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; color: var(--db-secondary-text); font-size: 12px;">Password</label>
                                    <input type="password" name="smtp_password" placeholder="Enter password to update" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button type="submit" name="save_smtp" style="padding: 8px 16px; background: var(--db-accent); color: white; border: none; border-radius: 6px; cursor: pointer;">Save SMTP Settings</button>
                                <button type="button" onclick="testSmtp()" style="padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer;">Test SMTP</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- WhatsApp Settings -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem; color: var(--db-primary-text);">WhatsApp Integration</h4>
                        <form method="POST" style="background: #f0f9ff; padding: 1.5rem; border-radius: 8px; border: 1px solid #bae6fd;">
                            <input type="hidden" name="settings_type" value="whatsapp">
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 5px; color: var(--db-secondary-text); font-size: 12px;">Integration Type</label>
                                <select name="integration_type" id="wa_integration_type" onchange="toggleWhatsAppFields()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="personal" {% if current_user.whatsapp_integration_type == 'personal' %}selected{% endif %}>Personal WhatsApp</option>
                                    <option value="twilio" {% if current_user.whatsapp_integration_type == 'twilio' %}selected{% endif %}>Twilio Integration</option>
                                    <option value="business" {% if current_user.whatsapp_integration_type == 'business' %}selected{% endif %}>WhatsApp Business API</option>
                                </select>
                            </div>
                            
                            <!-- Personal WhatsApp -->
                            <div id="wa_personalSection">
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 5px; color: var(--db-secondary-text); font-size: 12px;">WhatsApp Number</label>
                                    <input type="text" name="whatsapp_number" value="{{ current_user.whatsapp_number or '' }}" placeholder="+1234567890" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                    <small style="color: #6b7280; font-size: 0.8rem;">For personal WhatsApp, messages will open in WhatsApp Web/App</small>
                                </div>
                            </div>
                            
                            <!-- Twilio Section -->
                            <div id="wa_twilioSection" style="display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; color: var(--db-secondary-text); font-size: 12px;">Twilio Account SID</label>
                                        <input type="text" name="twilio_sid" value="{{ current_user.whatsapp_sid or '' }}" placeholder="AC..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; color: var(--db-secondary-text); font-size: 12px;">Twilio WhatsApp Number</label>
                                        <input type="text" name="twilio_whatsapp_number" value="{{ current_user.whatsapp_number or '' }}" placeholder="whatsapp:+14155238886" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                    </div>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 5px; color: var(--db-secondary-text); font-size: 12px;">Twilio Auth Token</label>
                                    <input type="password" name="twilio_auth_token" placeholder="Enter token to update" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                            
                            <!-- WhatsApp Business API Section -->
                            <div id="wa_businessSection" style="display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; color: var(--db-secondary-text); font-size: 12px;">Phone Number ID</label>
                                        <input type="text" name="business_phone_id" value="{{ current_user.whatsapp_business_phone_id or '' }}" placeholder="123456789012345" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; color: var(--db-secondary-text); font-size: 12px;">App ID</label>
                                        <input type="text" name="business_app_id" value="{{ current_user.whatsapp_business_app_id or '' }}" placeholder="123456789012345" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                    </div>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 5px; color: var(--db-secondary-text); font-size: 12px;">Business Access Token</label>
                                    <input type="password" name="business_token" placeholder="Enter token to update" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button type="submit" name="save_whatsapp" style="padding: 8px 16px; background: #059669; color: white; border: none; border-radius: 6px; cursor: pointer;">Save WhatsApp Settings</button>
                                <button type="button" onclick="testWhatsApp()" style="padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer;">Test Connection</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>
        </div>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function showSection(event, name) {
        event.preventDefault();
        const titles = {
            dashboard: 'Dashboard',
            contacts: 'Contact Management',
            email: 'New Email Campaign',
            campaigns: 'Campaign History',
            replies: 'Received Replies / Leads',
            whatsapp: 'WhatsApp Connect',
            settings: 'Integration Settings'
        };
        document.getElementById('pageTitle').textContent = titles[name] || 'Dashboard';
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(name).classList.add('active');
        document.querySelectorAll('.sidebar-nav .nav-item').forEach(n => n.classList.remove('active'));
        event.currentTarget.classList.add('active');
        if (window.innerWidth <= 1024) {
            document.getElementById('sidebar').classList.remove('open');
        }
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
    }

    function toggleCampaignDetails(campaignId) {
        const detailsRow = document.getElementById(campaignId);
        if (detailsRow.style.display === 'none' || detailsRow.style.display === '') {
            detailsRow.style.display = 'table-row';
        } else {
            detailsRow.style.display = 'none';
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        // --- Select All checkbox ---
        const selectAllCheckbox = document.getElementById('select_all_contacts');
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function (event) {
                const campaignContacts = document.querySelectorAll('#email .contact-checkbox');
                campaignContacts.forEach(checkbox => {
                    checkbox.checked = event.target.checked;
                });
            });
        }

        // --- LINE CHART (Emails Sent) ---
        const emailCtx = document.getElementById('emailSentChart').getContext('2d');
        let emailSentChart;

        function updateChart(labels, data) {
            if (emailSentChart) {
                emailSentChart.destroy();
            }
            emailSentChart = new Chart(emailCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Emails Sent',
                        data: data,
                        borderColor: '#111827',
                        backgroundColor: 'rgba(17, 24, 39, 0.05)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        async function fetchChartData(start, end) {
            try {
                const response = await fetch(`/chart-data?start=${start}&end=${end}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const newData = await response.json();
                updateChart(newData.labels, newData.data);
            } catch (error) {
                console.error('Failed to fetch chart data:', error);
                alert('Could not update chart data. Please check the console for errors.');
            }
        }

        // Initial chart load
        updateChart({{ chart_labels | tojson | safe }}, {{ chart_data | tojson | safe }});

        const filterBtn = document.getElementById('filter_chart_btn');
        if (filterBtn) {
            filterBtn.addEventListener('click', () => {
                const startDate = document.getElementById('start_date_input').value;
                const endDate = document.getElementById('end_date_input').value;
                if (startDate && endDate) {
                    fetchChartData(startDate, endDate);
                } else {
                    alert('Please select both a start and end date.');
                }
            });
        }

        // --- DOUGHNUT CHART (Campaigns) ---
        const campaignCtx = document.getElementById('campaignsChart').getContext('2d');
        new Chart(campaignCtx, {
            type: 'doughnut',
            data: {
                labels: ['Successful', 'Failed'],
                datasets: [{
                    data: [{{ successful_campaigns or 0 }}, {{ failed_campaigns or 0 }}],
                    backgroundColor: ['#22C55E', '#EF4444'],
                    borderColor: [
                        getComputedStyle(document.documentElement).getPropertyValue('--db-surface'),
                        getComputedStyle(document.documentElement).getPropertyValue('--db-surface')
                    ],
                    borderWidth: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '80%',
                plugins: { legend: { display: false } }
            }
        });

        // --- REPLIES MODAL ---
        const repliesSection = document.getElementById('replies');
        if (repliesSection) {
            const modal = repliesSection.querySelector("#replyModal");
            const closeBtn = modal.querySelector(".close");

            repliesSection.querySelectorAll(".btn-view-details").forEach(btn => {
                btn.addEventListener("click", function () {
                    modal.querySelector("#modalSubject").textContent = this.dataset.subject;
                    modal.querySelector("#modalName").textContent = this.dataset.name;
                    modal.querySelector("#modalEmail").textContent = this.dataset.email;
                    modal.querySelector("#modalDate").textContent = this.dataset.date;
                    modal.querySelector("#modalBody").textContent = this.dataset.body;
                    modal.style.display = "block";
                });
            });

            closeBtn.onclick = () => modal.style.display = "none";
            window.addEventListener('click', function (event) {
                if (event.target === modal) modal.style.display = "none";
            });
        }
    });
</script>

<!-- Edit Contact Modal -->
<div id="editContactModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div style="background-color: #fefefe; margin: 5% auto; padding: 20px; border-radius: 12px; width: 500px; max-width: 90%;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: var(--db-primary-text);">Edit Contact</h3>
            <span onclick="closeEditModal()" style="cursor: pointer; font-size: 24px; color: #aaa;">&times;</span>
        </div>
        
        <form method="POST" id="editContactForm">
            <input type="hidden" name="edit_contact" value="1">
            <input type="hidden" name="contact_id" id="editContactId">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; color: var(--db-secondary-text); font-size: 12px;">Company Name *</label>
                    <input type="text" name="company_name" id="editCompanyName" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; color: var(--db-secondary-text); font-size: 12px;">Contact Person</label>
                    <input type="text" name="contact" id="editContact" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                </div>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: var(--db-secondary-text); font-size: 12px;">Email *</label>
                <input type="email" name="email" id="editEmail" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; color: var(--db-secondary-text); font-size: 12px;">Phone Number</label>
                    <input type="tel" name="phone_number" id="editPhone" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; color: var(--db-secondary-text); font-size: 12px;">Company Type</label>
                    <input type="text" name="company_type" id="editCompanyType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; color: var(--db-secondary-text); font-size: 12px;">Location</label>
                <input type="text" name="location" id="editLocation" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="closeEditModal()" style="padding: 10px 20px; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
                <button type="submit" style="padding: 10px 20px; background: var(--db-accent); color: white; border: none; border-radius: 6px; cursor: pointer;">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<script>
function editContact(id, company, contact, email, phone, companyType, location) {
    document.getElementById('editContactId').value = id;
    document.getElementById('editCompanyName').value = company || '';
    document.getElementById('editContact').value = contact || '';
    document.getElementById('editEmail').value = email || '';
    document.getElementById('editPhone').value = phone || '';
    document.getElementById('editCompanyType').value = companyType || '';
    document.getElementById('editLocation').value = location || '';
    document.getElementById('editContactModal').style.display = 'block';
}

function closeEditModal() {
    document.getElementById('editContactModal').style.display = 'none';
}

// Close modal when clicking outside
window.addEventListener('click', function(event) {
    const modal = document.getElementById('editContactModal');
    if (event.target === modal) {
        closeEditModal();
    }
});

// Campaign selection functions
function toggleAllCampaigns() {
    const selectAll = document.getElementById('selectAllCampaigns');
    const checkboxes = document.querySelectorAll('.campaign-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function confirmDeleteSelected() {
    const selectedCampaigns = document.querySelectorAll('.campaign-checkbox:checked');
    if (selectedCampaigns.length === 0) {
        alert('Please select at least one campaign to delete.');
        return false;
    }
    
    // Add selected campaign IDs to the form
    const form = document.getElementById('deleteSelectedCampaignsForm');
    // Remove any existing hidden inputs
    form.querySelectorAll('input[name="campaign_ids"]').forEach(input => input.remove());
    
    selectedCampaigns.forEach(checkbox => {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'campaign_ids';
        hiddenInput.value = checkbox.value;
        form.appendChild(hiddenInput);
    });
    
    return confirm(`Are you sure you want to delete ${selectedCampaigns.length} selected campaign(s)?`);
}

// Settings form handlers
function toggleSmtpFields() {
    const sendMethod = document.getElementById('send_method').value;
    const customFields = document.getElementById('customSmtpFields');
    customFields.style.display = sendMethod === 'custom' ? 'block' : 'none';
}

function toggleWhatsAppFields() {
    const integrationType = document.getElementById('wa_integration_type').value;
    const personalSection = document.getElementById('wa_personalSection');
    const twilioSection = document.getElementById('wa_twilioSection');
    const businessSection = document.getElementById('wa_businessSection');
    
    // Hide all sections
    personalSection.style.display = 'none';
    twilioSection.style.display = 'none';
    businessSection.style.display = 'none';
    
    // Show relevant section
    if (integrationType === 'personal') {
        personalSection.style.display = 'block';
    } else if (integrationType === 'twilio') {
        twilioSection.style.display = 'block';
    } else if (integrationType === 'business') {
        businessSection.style.display = 'block';
    }
}

function testSmtp() {
    alert('SMTP test functionality will be implemented.');
}

function testWhatsApp() {
    alert('WhatsApp test functionality will be implemented.');
}

// Initialize settings on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleSmtpFields();
    toggleWhatsAppFields();
});
</script>


{% endblock %}